<html>
  <head>
    <title>Jack Lawrence Jones | Baritone</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
  </head>
  <body onload="onBodyLoad();">
    <div class="container">
      <img class="headshot" src="pig_production_shot.jpg" alt="Jack Lawrence-Jones' head">
      <h1>Jack Lawrence-Jones | Baritone</h1>
      <ul class="navigation">
        <li><a href="./about.html">about</a></li>
        <li class="current"><a href="./diary.html">diary</a></li>
        <li><a href="./contact.html">contact</a></li>
      </ul>
      <h2>Diary</h2>
      <div id="events">
      </div>
    </div>

    <script src="https://rawgit.com/moment/moment/2.2.1/min/moment.min.js"></script>
    <script>
    // onpageload, get events, sort in reverse chronological order,
    // and display in the 'diary' div

    function reverseChronologicalSort(a,b) {
      return new Date(b.start) - new Date(a.start);
    }

    function createEventElement(event) {
      // format date/time
      var start = moment(event.start);
      var end = moment(event.end);
      var dateHtml;
      if(start.isSame(end, 'day')) {
        // same day start and finish: ie a normal concert.
        // Display e.g. 7:30pm - 10pm, Saturday 7th January 2018
        var startTime = start.format('h:mm a');
        var endTime = end.format('h:mm a');
        var date = end.format('dddd Do MMMM, YYYY');
        dateHtml = `${startTime} - ${endTime}, ${date}`
      } else {
        var startDate = start.format('h:mm a, dddd Do MMMM, YYYY');
        var endDate = end.format('h:mm a, dddd Do MMMM, YYYY');
        dateHtml =`${startDate} - ${endDate}`;
      }

      var eventElement = document.createElement('div');
      eventElement.className = 'event';
      eventElement.innerHTML = `
      <div class="name">${event.url ? `<a href="${event.url}">` : ''}${event.name}${event.url ? '<\a>' : ''}</div>
      <div class="company">${event.venue_website ? `<a href="${event.venue_website}">` : ''}${event.company}${event.venue_website ? '<\a>' : ''}</div>
      <div class="date">${dateHtml}</div>
      <div class="address">${event.venue_name}, ${event.venue_address}</div>
      <div class="my_role">${event.my_role}</div>
      <div class="copy">${event.copy}</div>
      `;

      return eventElement;
    }

    function onBodyLoad() {
      console.log("body just loaded!!")
      const eventsContainer = document.getElementById('events');

      var events;
      var request = new XMLHttpRequest();
      request.open('GET', '/events', true);
      request.onload = function() {
        if(request.status >= 200) {
          events = JSON.parse(request.responseText);
          events.sort(reverseChronologicalSort);
          console.log(events);

          for (var i = 0, len = events.length; i < len; i++) {
            var eventElement = createEventElement(events[i]);
            eventsContainer.appendChild(eventElement);
          }

        } else {
          console.warn("error")
        }
      }

      request.onerror = function(error) {
        console.warn(error);
      };

      request.send();
    }
    </script>
  </body>
</html>
